import { Box, Divider, Grid, Typography } from '@mui/material';
import React, { useEffect, useState } from 'react';

import { fetchCve } from '../../../../../actions/cve-actions';
import { useFormatter } from '../../../../../components/i18n';
import type { CveOutput, FindingOutput } from '../../../../../utils/api-types';
import Loader from '../../../../../components/Loader';

interface Props {finding: FindingOutput}


const GeneralVulnerabilityInfoTab = ({ finding }: Props) => {
  const { fldt, t } = useFormatter();
  const [cve, setCve] = useState<CveOutput | null>(null);
  const [loading, setLoading] = useState<boolean>(true);
  const [notAvailable, setNotAvailable] = useState<boolean>(false);

  useEffect(() => {
    const loadCve = async () => {
      if (!finding.finding_value) return;

      setLoading(true);
      setNotAvailable(false);

      try {
        const res = await fetchCve(finding.finding_value);
        setCve(res.data);
      } catch (err: any) {
        if (err?.response?.status === 404) {
          setNotAvailable(true);
        }
        setCve(null);
      } finally {
        setLoading(false);
      }
    };
    loadCve();
  }, [finding]);

  if (loading) {
    return <Loader />;
  }

  if (notAvailable) {
    return (
      <Box p={4}>
        <Typography>
          {t('We do not have information about this CVE yet.')}
        </Typography>
      </Box>
    );
  }

  return (
    <Box p={4}>
      {/* CVE Title */}
      <Typography variant="h5" gutterBottom>
        {cve?.cve_id || t('Unknown CVE')}
      </Typography>

      {/* Description */}
      <Typography variant="subtitle1" fontWeight="bold" gutterBottom>
        {t('Description')}
      </Typography>
      <Typography variant="body2">
        {cve?.cve_description || t('No description available.')}
      </Typography>

      <Divider sx={{ my: 2 }} />

      {/* Quick Info */}
      <Typography variant="subtitle1" fontWeight="bold" gutterBottom>
        {t('Quick Info')}
      </Typography>
      <Grid container spacing={2}>
        <Grid xs={12} md={6}>
          <Typography variant="body2">
            <strong>{t('Published')}:</strong>{' '}
            {cve?.cve_published ? fldt(cve.cve_published) : t('N/A')}
          </Typography>
        </Grid>
        <Grid xs={12} md={6}>
          <Typography variant="body2">
            <strong>{t('Source')}:</strong>{' '}
            {cve?.cve_source_identifier || t('N/A')}
          </Typography>
        </Grid>
      </Grid>

      <Divider sx={{ my: 2 }} />
    </Box>
  );
};

export default GeneralVulnerabilityInfoTab;
